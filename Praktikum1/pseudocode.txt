MessageADT = {Text,COut,HBQIn,DLQIn,CIn}
ClientsADT = {ClientID,LastNumber,TimeStamp}
HBQADT = [{{Text,COut,HBQIn,DLQIn,CIn},Nr}]
DLQADT = [{{Text,COut,HBQIn,DLQIn,CIn},Nr}]

startserver()
	Pid = spawn timer(5)
	dispatcher(1,[],[{"dummy",0,0,0,0,0}],[],Pid)
end

dispatcher(Nr,HBQ,DLQ,Clients,Tid)
	getMessage 
		{getmsgid,Pid} ->
			Nr' = sendMessageId(Nr,Pid)
			HBQ' = HBQ
			DLQ' = DLQ
			Clients' = Clients
		{dropmessage, {{Text,COut,HBQIn,DLQIn,CIn},Nr}} ->
			Nr' = Nr
			HBQ' = [{{Text,COut,System.Time,DLQIn,CIn},Nr} | HBQ]
			DLQ' = DLQ
			Clients' = Clients
		{getmessages, Pid} ->
			if (Clients.hasNoElementWith(Pid))
				TempClients = addClient(Clients,{Pid,1,System.Time})
			else
				TempClients = refreshClientTimer(Clients,Pid)
			fi
			Clients' = sendMessages(TempClients,Pid,DLQ)
		{shutdown} ->
			terminateFunction
	endGetMessage
	
	informTimer(Tid)
	LivingClients = deleteTimedOutClients(Clients', System.Time)
	SortedHBQ = sort(HBQ')
	
	{RefreshedDLQ,RefreshedHBQ} = fillDLQ(DLQ',SortedHBQ)
	
	dispatcher(Nr',RefreshedHBQ},RefreshedDLQ,LivingClients,Tid)
end